<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCIXXY-JS</title>
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
            /* Stacking elements vertically */
            font-family: Arial, sans-serif;
        }

        #header {
            text-align: center;
            opacity: 0.7;
            margin-bottom: 20px;
        }

        #siteName {
            font-size: 24px;
            font-weight: bold;
        }

        #username {
            font-size: 18px;
        }

        #canvasContainer {
            position: relative;
            width: 300px;
            /* Set the width of the container */
            height: 300px;
            /* Set the height of the container */
        }

        canvas {
            border: 1px solid #000;
            position: absolute;
            top: 0;
            left: 0;
        }

        #tracingCanvas {
            border: 1px solid #000;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            /* Make tracing canvas non-interactive */
        }

        button {
            margin-top: 15px;
            /* Adding more margin between button and audio */
        }

        input[type="file"],
        input[type="checkbox"] {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div id="header">
        <div id="siteName">OSCIXXY-JS</div>
        <div id="username">bluepenguins</div>
    </div>

    <label for="imageInput">Tracing Image:</label>
    <input type="file" id="imageInput" accept="image/*">
    <br>
    <input type="checkbox" id="tracingCheckbox"> Enable Tracing Image <br>
    <div id="canvasContainer">
        <canvas id="canvas" width="300" height="300"></canvas>
        <canvas id="tracingCanvas" width="300" height="300"></canvas>
    </div>
    <button id="clearButton">Clear Canvas</button>
    <audio id="audio" controls></audio>
    <script>
        var canvas, tracingCanvas, ctx, tracingCtx;
        var isDrawing = false;
        var xData, yData; // Declare xData and yData without initialization
        var tracingImage;
        canvas = document.getElementById('canvas');
        tracingCanvas = document.getElementById('tracingCanvas');
        ctx = canvas.getContext('2d');
        tracingCtx = tracingCanvas.getContext('2d');
        ctx.strokeStyle = '#000'; // Set pen color to black
        ctx.lineWidth = 2;
        var imageInput = document.getElementById('imageInput');
        var tracingCheckbox = document.getElementById('tracingCheckbox');
        // Add event listener for image input change
        imageInput.addEventListener('change', handleImageUpload, false);
        // Add event listener for checkbox change
        tracingCheckbox.addEventListener('change', toggleTracingImage, false);
        canvas.addEventListener('mousedown', startDrawing, false);
        canvas.addEventListener('mousemove', draw, false);
        canvas.addEventListener('mouseup', stopDrawing, false);
        canvas.addEventListener('mouseout', stopDrawing, false);
        // Add event listener for clearing the canvas
        var clearButton = document.getElementById('clearButton');
        clearButton.addEventListener('click', clearCanvas, false);

        function startDrawing(e) {
            isDrawing = true;
            xData = []; // Clear xData array when starting a new drawing
            yData = []; // Clear yData array when starting a new drawing
            var xy = getXY();
            ctx.beginPath();
            ctx.moveTo(e.clientX - xy.x, e.clientY - xy.y);
            xData.push(clamp(e.clientX - xy.x)); // Swap X and Y coordinates for oscilloscope visuals
            yData.push(clamp(e.clientY - xy.y)); // Swap X and Y coordinates for oscilloscope visuals
        }

        function draw(e) {
            if (!isDrawing) return;
            var xy = getXY();
            ctx.lineTo(e.clientX - xy.x, e.clientY - xy.y);
            ctx.stroke();
            xData.push(clamp(e.clientX - xy.x)); // Swap X and Y coordinates for oscilloscope visuals
            yData.push(clamp(e.clientY - xy.y)); // Swap X and Y coordinates for oscilloscope visuals
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.closePath();
            if (xData.length > 1) {
                play();
            }
            ctx.globalCompositeOperation = 'source-over'; // Reset blending mode to default
            ctx.strokeStyle = '#000'; // Reset pen color to black
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawTracingImage(); // Redraw tracing image after clearing
        }

        function handleImageUpload() {
            var input = imageInput;
            var reader = new FileReader();
            reader.onload = function (e) {
                tracingImage = new Image();
                tracingImage.onload = function () {
                    drawTracingImage();
                };
                tracingImage.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function drawTracingImage() {
            tracingCtx.clearRect(0, 0, tracingCanvas.width, tracingCanvas.height); // Clear the tracing canvas
            if (tracingCheckbox.checked && tracingImage) {
                tracingCtx.globalAlpha = 0.5; // Set opacity
                tracingCtx.drawImage(tracingImage, 0, 0, tracingCanvas.width, tracingCanvas.height);
                tracingCtx.globalAlpha = 1; // Reset opacity
            }
        }

        function toggleTracingImage() {
            drawTracingImage(); // Redraw tracing image when checkbox state changes
        }

        function repeatArray(array, n) {
            // Return an array of length n,
            // made of repeated copies of the input array.
            var repeated = array.slice();
            while (repeated.length < n) {
                repeated = repeated.concat(repeated);
            }
            return repeated.slice(0, n);
        }

        function play() {
            // Generate about 1 minute worth of data.
            var length = 1200000; // 60 seconds * 20000 samples per second

            // Apply transformations to xData and yData
            var transformedX = xData.map(transformX);
            var transformedY = yData.map(transformY);

            // Repeat the transformed data
            var left = repeatArray(transformedY, length);
            var right = repeatArray(transformedX, length);

            // Play the sound
            var wav = makeWav(left, right);
            var audio = document.getElementById('audio');
            audio.src = 'data:audio/x-wav;base64,' + btoa(wav);
            audio.play();
        }

        // Transformation functions for X data
        function swapX(value) {
            // Swap X and Y coordinates
            return canvas.height - value;
        }

        function invertX(value) {
            // Invert X coordinate
            return canvas.width - value;
        }

        function flipHorizontalX(value) {
            // Flip horizontally by subtracting X coordinate from canvas width
            return value;
        }

        // Transformation functions for Y data
        function swapY(value) {
            // Swap Y and X coordinates
            return canvas.width - value;
        }

        function invertY(value) {
            // Invert Y coordinate
            return canvas.height - value;
        }

        function flipHorizontalY(value) {
            // Flip horizontally by subtracting Y coordinate from canvas height
            return value;
        }

        // Apply transformations to X and Y data
        function transformX(value) {
            // Combine swapping X/Y and inverting X and Y
            return flipHorizontalY(invertY(swapY(invertX(swapX(value)))));
        }

        function transformY(value) {
            // Combine swapping X/Y and inverting X and Y
            return flipHorizontalX(invertX(swapX(invertY(swapY(value)))));
        }

        function makeWav(left, right) {
            // Return a stereo WAV file built from the provided data arrays.
            var min = Math.min(left.length, right.length);
            var SubChunk2Size = min * 2;
            // RIFF chunk descriptor.
            var file = 'RIFF';
            file += numToLong(36 + SubChunk2Size); // ChunkSize
            file += 'WAVE';
            // The 'fmt ' sub-chunk.
            file += 'fmt ';
            file += numToLong(16); // Subchunk1Size
            file += numToShort(1); // AudioFormat
            file += numToShort(2); // NumChannels
            file += numToLong(22050); // SampleRate
            file += numToLong(22050 * 2); // ByteRate
            file += numToShort(2); // BlockAlign
            file += numToShort(8); // BitsPerSample
            // The 'data' sub-chunk.
            file += 'data';
            file += numToLong(SubChunk2Size);
            for (var i = 0; i < min; i++) {
                file += numToChar(left[i]) + numToChar(right[i]);
            }
            return file;
        }

        function numToChar(num) {
            // num is 0 - 255
            return String.fromCharCode(num);
        }

        function numToShort(num) {
            // num is 0 - 65536
            var b0 = num % 256; // low
            var b1 = (num - b0) / 256; // high
            return String.fromCharCode(b0) + String.fromCharCode(b1);
        }

        function numToLong(num) {
            // num is 0 - 4.2 billion
            var b0 = num % 256;
            num = (num - b0) / 256;
            var b1 = num % 256;
            num = (num - b1) / 256;
            var b2 = num % 256;
            num = (num - b2) / 256;
            var b3 = num;
            return String.fromCharCode(b0) + String.fromCharCode(b1) + String.fromCharCode(b2) + String.fromCharCode(b3);
        }

        function clamp(n) {
            // Integer only, 0-255.
            n = Math.round(n);
            return Math.max(0, Math.min(255, n));
        }

        function getXY() {
            var x = 0;
            var y = 0;
            var o = canvas;
            while (o) {
                x += o.offsetLeft;
                y += o.offsetTop;
                o = o.offsetParent;
            }
            try {
                x -= document.scrollingElement.scrollLeft;
                y -= document.scrollingElement.scrollTop;
            } catch (e) {
                /* MSIE? */
            }
            return {
                x: x,
                y: y
            };
        }
    </script>
</body>

</html>
